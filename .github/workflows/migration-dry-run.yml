name: Migration Dry Run

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: {}

jobs:
  migrate-dry-run:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_USER: gha_user
          POSTGRES_PASSWORD: gha_pass
          POSTGRES_DB: unda_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U gha_user -d unda_test" \
          --health-interval 5s \
          --health-timeout 5s \
          --health-retries 20

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install system deps (psql)
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Wait for Postgres
        env:
          PGPASSWORD: gha_pass
        run: |
          for i in {1..30}; do
            pg_isready -h localhost -p 5432 -U gha_user -d unda_test && break || sleep 2
          done

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run migrations (dry-run)
        env:
          DATABASE_URL: postgresql://gha_user:gha_pass@localhost:5432/unda_test
          FLASK_APP: app.py
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          set -euo pipefail
          # ensure DB exists (postgres service should create it), then run the migration runner
          scripts/run_migrations.sh || (echo "Migration runner failed; showing last 200 lines:" && tail -n 200 /tmp/migration.log && exit 1)
