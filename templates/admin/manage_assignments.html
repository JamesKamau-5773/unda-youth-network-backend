{% extends "base.html" %}

{% block title %}Manage Champion Assignments - Admin Dashboard{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1 class="dashboard-title">Manage Champion-Supervisor Assignments</h1>
    <p class="dashboard-subtitle">Assign champions to supervisors for mentorship and monitoring</p>
</div>

<div style="margin-bottom: 2rem;">
    <a href="{{ url_for('admin.dashboard') }}" class="btn btn--secondary">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        Back to Admin Dashboard
    </a>
</div>

<!-- Summary Stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 00-3-3.87"></path>
                <path d="M16 3.13a4 4 0 010 7.75"></path>
            </svg>
        </div>
        <div class="stat-content">
            <p class="stat-value">{{ champions|length }}</p>
            <p class="stat-label">Total Champions</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <polyline points="17 11 19 13 23 9"></polyline>
            </svg>
        </div>
        <div class="stat-content">
            <p class="stat-value">{{ supervisors|length }}</p>
            <p class="stat-label">Active Supervisors</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
        </div>
        <div class="stat-content">
            <p class="stat-value">{{ unassigned_champions|length }}</p>
            <p class="stat-label">Unassigned Champions</p>
        </div>
    </div>
</div>

<!-- Unassigned Champions -->
{% if unassigned_champions %}
<div class="data-card" style="margin-bottom: 2rem;">
    <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); background: #fef3c7;">
        <h3 style="font-size: 1.125rem; font-weight: 600; margin: 0; color: #92400e; display: flex; align-items: center; gap: 0.5rem;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            Unassigned Champions ({{ unassigned_champions|length }})
        </h3>
        <p style="font-size: 0.875rem; color: #78350f; margin: 0.25rem 0 0 0;">These champions need supervisor assignment for proper mentorship</p>
    </div>
    
    <div style="padding: 1.5rem;">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Champion Code</th>
                        <th>Full Name</th>
                        <th>Username</th>
                        <th>Status</th>
                        <th>Assign to Supervisor</th>
                    </tr>
                </thead>
                <tbody>
                    {% for champion in unassigned_champions %}
                    <tr>
                        <td><span class="badge badge--primary">{{ champion.assigned_champion_code }}</span></td>
                        <td><strong>{{ champion.full_name }}</strong></td>
                        <td>{{ champion.username }}</td>
                        <td>
                            <span class="badge {% if champion.champion_status == 'Active' %}badge--success{% else %}badge--secondary{% endif %}">
                                {{ champion.champion_status }}
                            </span>
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('admin.assign_champion', champion_id=champion.champion_id) }}" style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <select name="supervisor_id" class="form-input" style="min-width: 200px;" required>
                                    <option value="">-- Select Supervisor --</option>
                                    {% for supervisor in supervisors %}
                                    <option value="{{ supervisor.user_id }}">{{ supervisor.username }}</option>
                                    {% endfor %}
                                </select>
                                <button type="submit" class="btn btn--primary" style="white-space: nowrap;">Assign</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Assigned Champions by Supervisor -->
<div class="data-card">
    <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); background: #f8fafc;">
        <h3 style="font-size: 1.125rem; font-weight: 600; margin: 0; color: #334155;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 00-3-3.87"></path>
                <path d="M16 3.13a4 4 0 010 7.75"></path>
            </svg>
            Assigned Champions by Supervisor
        </h3>
        <p style="font-size: 0.875rem; color: #64748b; margin: 0.25rem 0 0 0;">View and reassign champions under each supervisor</p>
    </div>
    
    <div style="padding: 1.5rem;">
        {% if supervisors %}
            {% for supervisor in supervisors %}
            <div style="margin-bottom: 2rem; padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 0.5rem; background: #fafbfc;">
                <h4 style="font-size: 1rem; font-weight: 600; color: #1e293b; margin: 0 0 1rem 0; display: flex; align-items: center; justify-content: space-between;">
                    <span>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        {{ supervisor.username }}
                    </span>
                    <span class="badge badge--info">
                        {{ assigned_champions.get(supervisor.user_id, [])|length }} Champions
                    </span>
                </h4>
                
                {% if assigned_champions.get(supervisor.user_id) %}
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Champion Code</th>
                                <th>Full Name</th>
                                <th>Username</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for champion in assigned_champions.get(supervisor.user_id, []) %}
                            <tr>
                                <td><span class="badge badge--primary">{{ champion.assigned_champion_code }}</span></td>
                                <td><strong>{{ champion.full_name }}</strong></td>
                                <td>{{ champion.username }}</td>
                                <td>
                                    <span class="badge {% if champion.champion_status == 'Active' %}badge--success{% else %}badge--secondary{% endif %}">
                                        {{ champion.champion_status }}
                                    </span>
                                </td>
                                <td>
                                    <form method="POST" action="{{ url_for('admin.assign_champion', champion_id=champion.champion_id) }}" style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <select name="supervisor_id" class="form-input" style="min-width: 200px;">
                                            <option value="">-- Unassign --</option>
                                            {% for sup in supervisors %}
                                            <option value="{{ sup.user_id }}" {% if sup.user_id == supervisor.user_id %}selected{% endif %}>
                                                {{ sup.username }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <button type="submit" class="btn btn--secondary" style="white-space: nowrap;">Update</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p style="color: #64748b; font-style: italic; margin: 0;">No champions assigned to this supervisor yet</p>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
        <p style="color: #64748b; font-style: italic;">No supervisors available. Please create supervisor accounts first.</p>
        {% endif %}
    </div>
</div>

{% endblock %}
