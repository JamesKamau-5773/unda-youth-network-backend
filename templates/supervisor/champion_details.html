{% extends "base.html" %}
{% block title %}Champion Review{% endblock %}

{% block content %}
<div style="margin-bottom: 1.5rem;">
	<a href="{{ url_for('supervisor.dashboard') }}" class="btn btn--secondary">
		<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
			<line x1="19" y1="12" x2="5" y2="12"></line>
			<polyline points="12 19 5 12 12 5"></polyline>
		</svg>
		Back to Dashboard
	</a>
</div>

<div class="dashboard-header">
	<h1 class="dashboard-title">{{ champion.full_name }}</h1>
	<p class="dashboard-subtitle">
		<span class="badge badge--primary">{{ champion.assigned_champion_code }}</span>
		<span class="badge badge--secondary" style="margin-left: 0.5rem;">{{ champion.assigned_cohort }}</span>
		{% if champion.risk_level == 'High' %}
		<span class="badge" style="background: #dc2626; color: white; margin-left: 0.5rem;">
			<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
				<circle cx="12" cy="12" r="10"></circle>
				<line x1="12" y1="8" x2="12" y2="12"></line>
				<line x1="12" y1="16" x2="12.01" y2="16"></line>
			</svg>
			High Risk
		</span>
		{% elif champion.risk_level == 'Medium' %}
		<span class="badge" style="background: #f59e0b; color: white; margin-left: 0.5rem;">
			<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
				<path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path>
			</svg>
			Medium Risk
		</span>
		{% else %}
		<span class="badge" style="background: #10b981; color: white; margin-left: 0.5rem;">
			<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
				<polyline points="20 6 9 17 4 12"></polyline>
			</svg>
			Low Risk
		</span>
		{% endif %}
	</p>
</div>

<!-- Health & Risk Assessment Section -->
<div class="data-card" style="margin-bottom: 2rem;">
	<div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); background: #f8fafc;">
		<h3 style="font-size: 1.125rem; font-weight: 600; margin: 0; color: #334155;">Health & Safety Information</h3>
		<p style="font-size: 0.875rem; color: #64748b; margin: 0.25rem 0 0 0;">Confidential safeguarding and wellbeing data</p>
	</div>
	
	<form method="POST" style="padding: 1.5rem;">
		<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
		<input type="hidden" name="action" value="update_health_risk">
		{% set risk_value = champion.risk_level if prefill else 'Low' %}
		
		<!-- Health Information -->
		<div style="margin-bottom: 1.5rem;">
			<h4 style="font-size: 1rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e2e8f0;">Health Information</h4>
			
			<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
				<div class="form-group">
					<label class="form-label">Medical Conditions</label>
					<textarea name="medical_conditions" class="form-input" rows="2" placeholder="Known medical conditions">{{ champion.medical_conditions if prefill else '' }}</textarea>
				</div>
				
				<div class="form-group">
					<label class="form-label">Allergies</label>
					<textarea name="allergies" class="form-input" rows="2" placeholder="Food, medication, or environmental allergies">{{ champion.allergies if prefill else '' }}</textarea>
				</div>
				
				<div class="form-group">
					<label class="form-label">Mental Health Support</label>
					<textarea name="mental_health_support" class="form-input" rows="2" placeholder="Current mental health support or needs">{{ champion.mental_health_support if prefill else '' }}</textarea>
				</div>
				
				<div class="form-group">
					<label class="form-label">Disabilities / Additional Needs</label>
					<textarea name="disabilities" class="form-input" rows="2" placeholder="Physical, learning, or developmental needs">{{ champion.disabilities if prefill else '' }}</textarea>
				</div>
				
				<div class="form-group">
					<label class="form-label">Medication Required</label>
					<input type="text" name="medication_required" class="form-input" placeholder="Current prescribed medications" value="{{ champion.medication_required if prefill else '' }}">
				</div>
				
				<div class="form-group">
					<label class="form-label">Dietary Requirements</label>
					<input type="text" name="dietary_requirements" class="form-input" placeholder="Religious, medical, or preference-based" value="{{ champion.dietary_requirements if prefill else '' }}">
				</div>
			</div>
			
			<div class="form-group">
				<label class="form-label">Additional Health Notes</label>
				<textarea name="health_notes" class="form-input" rows="3" placeholder="Any other relevant health or wellbeing information">{{ champion.health_notes if prefill else '' }}</textarea>
			</div>
		</div>
		
		<!-- Risk Assessment -->
		<div style="margin-bottom: 1.5rem;">
			<h4 style="font-size: 1rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e2e8f0;">Risk Assessment</h4>
			
			<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
				<div class="form-group">
					<label class="form-label">Risk Level <span style="color: #dc2626;">*</span></label>
					<select name="risk_level" class="form-input" required>
						<option value="Low" {% if risk_value == 'Low' %}selected{% endif %}>Low</option>
						<option value="Medium" {% if risk_value == 'Medium' %}selected{% endif %}>Medium</option>
						<option value="High" {% if risk_value == 'High' %}selected{% endif %}>High</option>
					</select>
				</div>
				
				<div class="form-group">
					<label class="form-label">Last Contact Date</label>
					<input type="date" name="last_contact_date" class="form-input" value="{{ champion.last_contact_date.strftime('%Y-%m-%d') if prefill and champion.last_contact_date else '' }}">
				</div>
				
				<div class="form-group">
					<label class="form-label">Next Review Date <span style="color: #dc2626;">*</span></label>
					<input type="date" name="next_review_date" class="form-input" value="{{ champion.next_review_date.strftime('%Y-%m-%d') if prefill and champion.next_review_date else '' }}" required>
				</div>
			</div>
			
			<div class="form-group">
				<label class="form-label">Risk Assessment Notes</label>
				<textarea name="risk_notes" class="form-input" rows="4" placeholder="Detail specific risk factors, protective factors, intervention plans, and safeguarding concerns">{{ champion.risk_notes if prefill else '' }}</textarea>
			</div>
			
			{% if champion.risk_assessment_date %}
			<p style="font-size: 0.875rem; color: #64748b; margin-top: 0.5rem;">
				Last assessment: {{ champion.risk_assessment_date.strftime('%Y-%m-%d %H:%M') }}
			</p>
			{% endif %}
		</div>
		
		<div style="display: flex; gap: 0.75rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--border-color);">
			<button type="submit" class="btn btn--primary">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
					<path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path>
					<polyline points="17 21 17 13 7 13 7 21"></polyline>
					<polyline points="7 3 7 8 15 8"></polyline>
				</svg>
				Save Health & Risk Data
			</button>
		</div>
	</form>
</div>

<!-- Content Grid -->
<div style="display: grid; grid-template-columns: 1fr 380px; gap: 2rem; align-items: start;">
	<!-- Operational Reports -->
	<div>
		<div class="section-header">
			<h2 class="section-title">Operational Reports</h2>
			<p class="section-subtitle">Monthly submissions and performance tracking</p>
		</div>
		
		{% if history %}
		<div style="display: flex; flex-direction: column; gap: 1.5rem;">
			{% for report in history %}
			<div class="data-card">
				<div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); background: var(--clean-bg);">
					<div style="display: flex; justify-content: space-between; align-items: center;">
						<h3 style="font-size: 1.125rem; font-weight: 600; margin: 0;">{{ report.reporting_period.strftime('%B %Y') }}</h3>
						<span class="badge badge--primary">{{ report.referrals_initiated or 0 }} Referrals</span>
					</div>
				</div>
				
				<div style="padding: 1.5rem;">
					<!-- Metrics Grid -->
					<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
						<div>
							<div style="font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Check-In Rate</div>
							<div style="font-size: 1.5rem; font-weight: 700; color: var(--trust-blue);">{{ report.weekly_check_in_completion_rate or 'N/A' }}{% if report.weekly_check_in_completion_rate %}%{% endif %}</div>
						</div>
						<div>
							<div style="font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Screenings</div>
							<div style="font-size: 1.5rem; font-weight: 700; color: var(--status-certified);">{{ report.monthly_mini_screenings_delivered or 0 }}</div>
						</div>
						<div>
							<div style="font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Quality Score</div>
							<div style="font-size: 1rem; font-weight: 600;">
								{% if report.documentation_quality_score == 'complete' %}
									<span class="badge badge--success">Complete</span>
								{% elif report.documentation_quality_score == 'partial' %}
									<span class="badge badge--warning">Partial</span>
								{% else %}
									<span class="badge badge--secondary">{{ report.documentation_quality_score or 'Unrated' }}</span>
								{% endif %}
							</div>
						</div>
					</div>
					
					<!-- Wellbeing Check -->
					<div style="margin-bottom: 1.5rem;">
						<div style="font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Wellbeing Check</div>
						<div style="padding: 1rem; background: var(--clean-bg); border-radius: var(--border-radius); color: var(--text-secondary); font-size: 0.9375rem;">
							{{ report.self_reported_wellbeing_check or 'No entry provided' }}
						</div>
					</div>

					<!-- Safeguarding Notes Form -->
					<form method="POST" style="margin-bottom: 1.5rem;">
						<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
						<input type="hidden" name="action" value="update_safeguarding">
						<input type="hidden" name="report_id" value="{{ report.support_id }}">
						<div class="form-group">
							<label class="form-label">Safeguarding Notes (Confidential)</label>
							<textarea name="safeguarding_notes" class="form-input" rows="2" placeholder="Record safeguarding context or actions; visible to supervisors/admins only.">{{ report.safeguarding_notes if prefill else '' }}</textarea>
						</div>
					<div style="margin-top: 0.75rem;">
						<button class="btn btn--warning" type="submit">
							<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
								<path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path>
								<polyline points="17 21 17 13 7 13 7 21"></polyline>
								<polyline points="7 3 7 8 15 8"></polyline>
							</svg>
							Save Safeguarding Notes
						</button>
					</div>
					</form>

					<!-- Supervisor Notes Form -->
					<form method="POST" style="margin-bottom: 1.5rem;">
						<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
						<input type="hidden" name="action" value="update_notes">
						<input type="hidden" name="report_id" value="{{ report.support_id }}">
						<div class="form-group">
							<label class="form-label">Supervisor Notes</label>
							<textarea name="notes" class="form-input" rows="2" placeholder="Log follow-up actions or concerns">{{ report.supervisor_notes if prefill else '' }}</textarea>
						</div>
					<div style="margin-top: 0.75rem;">
						<button class="btn btn--secondary" type="submit">
							<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
								<path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path>
								<polyline points="17 21 17 13 7 13 7 21"></polyline>
								<polyline points="7 3 7 8 15 8"></polyline>
							</svg>
							Save Notes
						</button>
					</div>
					</form>

					<!-- Quality Score Update -->
					<form method="POST">
						<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
						<input type="hidden" name="action" value="update_quality">
						<input type="hidden" name="report_id" value="{{ report.support_id }}">
						<div class="form-group">
							<label class="form-label">Update Documentation Quality</label>
							<select class="form-input" name="doc_quality" required>
								<option value="">Select score</option>
								{% for option in ['complete','partial','incomplete'] %}
									<option value="{{ option }}" {% if report.documentation_quality_score == option %}selected{% endif %}>{{ option|capitalize }}</option>
								{% endfor %}
							</select>
						</div>
						<div style="margin-top: 0.75rem;">
							<button class="btn btn--primary" type="submit">
								<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
									<polyline points="20 6 9 17 4 12"></polyline>
								</svg>
								Update Quality Score
							</button>
						</div>
					</form>
				</div>
			</div>
			{% endfor %}
		</div>
		{% else %}
		<div class="data-card">
			<div class="empty-state">
				<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
					<polyline points="14 2 14 8 20 8"></polyline>
					<line x1="16" y1="13" x2="8" y2="13"></line>
					<line x1="16" y1="17" x2="8" y2="17"></line>
					<polyline points="10 9 9 9 8 9"></polyline>
				</svg>
				<p class="empty-state-text">No reports submitted yet</p>
			</div>
		</div>
		{% endif %}
	</div>

	<!-- Referral Pathways Sidebar -->
	<div style="position: sticky; top: 2rem;">
		<div class="section-header" style="margin-bottom: 1rem;">
			<h2 class="section-title" style="font-size: 1.25rem;">Referral Pathways</h2>
		</div>
		
		<div class="data-card" style="margin-bottom: 1.5rem;">
			<form method="POST" class="report-form" style="padding: 1.5rem;">
				<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
				<input type="hidden" name="action" value="add_referral">
				<div class="form-group">
					<label class="form-label">Youth Referred</label>
					<input type="number" min="0" class="form-input" name="youth_referred_number" placeholder="Number of youth">
				</div>
				<div class="form-group">
					<label class="form-label">Referral Destination</label>
					<input type="text" class="form-input" name="referral_destination" placeholder="Partner therapist / service">
				</div>
				<div class="form-group">
					<label class="form-label">Referral Outcome</label>
					<select class="form-input" name="referral_outcome">
						<option value="">Select outcome</option>
						<option value="Attended">Attended</option>
						<option value="Pending">Pending</option>
						<option value="Declined">Declined</option>
					</select>
				</div>
			<button class="btn btn--primary btn--block" style="margin-top: 0.5rem;" type="submit">
				<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
					<line x1="12" y1="5" x2="12" y2="19"></line>
					<line x1="5" y1="12" x2="19" y2="12"></line>
				</svg>
				Add Referral
			</button>
			</form>
		</div>

		<!-- Referral List -->
		{% if referrals %}
		<div style="display: flex; flex-direction: column; gap: 0.75rem;">
			{% for referral in referrals %}
			<div class="data-card">
				<div style="padding: 1rem;">
					<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
						<span style="font-size: 0.8125rem; color: var(--text-secondary);">{{ referral.date_initiated.strftime('%Y-%m-%d') }}</span>
						{% if referral.referal_outcomes == 'Attended' %}
							<span class="badge badge--success">{{ referral.referal_outcomes }}</span>
						{% elif referral.referal_outcomes == 'Pending' %}
							<span class="badge badge--warning">{{ referral.referal_outcomes or 'Pending' }}</span>
						{% else %}
							<span class="badge badge--danger">{{ referral.referal_outcomes or 'Pending' }}</span>
						{% endif %}
					</div>
					<div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
						<div>
							<span style="color: var(--text-secondary);">Destination:</span>
							<span style="font-weight: 500; color: var(--text-primary);">{{ referral.referral_destinations or 'N/A' }}</span>
						</div>
						<div>
							<span style="color: var(--text-secondary);">Youth Referred:</span>
							<span class="metric-badge" style="min-width: 28px; height: 20px; font-size: 0.75rem;">{{ referral.youth_referred_number or 0 }}</span>
						</div>
						<div>
							<span style="color: var(--text-secondary);">Response Time:</span>
							<span style="font-weight: 500; color: var(--text-primary);">{{ referral.flag_to_referral_days if referral.flag_to_referral_days is not none else 'N/A' }} days</span>
						</div>
					</div>
				</div>
			</div>
			{% endfor %}
		</div>
		{% else %}
		<div class="data-card">
			<div class="empty-state" style="padding: 1.5rem;">
				<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 0.5rem;">
					<path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path>
					<circle cx="8.5" cy="7" r="4"></circle>
					<line x1="20" y1="8" x2="20" y2="14"></line>
					<line x1="23" y1="11" x2="17" y2="11"></line>
				</svg>
				<p class="empty-state-text" style="font-size: 0.875rem;">No referral pathways recorded yet</p>
			</div>
		</div>
		{% endif %}
	</div>
</div>

{% endblock %}
